# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class CostgraphAgent < Formula
  desc "VM agent for Costgraph"
  homepage "https://costgraph.baselinehq.cloud/"
  version "0.0.30"

  on_macos do
    if Hardware::CPU.intel?
      url "https://costgraph-agent-bin.s3.amazonaws.com/v0.0.30/costgraph-agent_v0.0.30_darwin_amd64.tar.gz"
      sha256 "64e302f4d94730af9fa7c9b8775643e7007cf932427c9a5ecf3bffc53cd5d51a"

      def install
        bin.install "costgraph-agent"
        if OS.mac?
          if Hardware::CPU.arm?
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_arm64.dylib" => "libdarwin_exporter.dylib"
          else
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_amd64.dylib" => "libdarwin_exporter.dylib"
          end
        end
      end
    end
    if Hardware::CPU.arm?
      url "https://costgraph-agent-bin.s3.amazonaws.com/v0.0.30/costgraph-agent_v0.0.30_darwin_arm64.tar.gz"
      sha256 "27cae6d7fec7632bd9f63e85f3c09f8460775e4a2dcc3e7d5867fac9afe78c9d"

      def install
        bin.install "costgraph-agent"
        if OS.mac?
          if Hardware::CPU.arm?
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_arm64.dylib" => "libdarwin_exporter.dylib"
          else
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_amd64.dylib" => "libdarwin_exporter.dylib"
          end
        end
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://costgraph-agent-bin.s3.amazonaws.com/v0.0.30/costgraph-agent_v0.0.30_linux_amd64.tar.gz"
      sha256 "667a6eddb9488e45c0e1a54db696d31f76bbf920b29c63d90fa9e03c751209f4"
      def install
        bin.install "costgraph-agent"
        if OS.mac?
          if Hardware::CPU.arm?
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_arm64.dylib" => "libdarwin_exporter.dylib"
          else
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_amd64.dylib" => "libdarwin_exporter.dylib"
          end
        end
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://costgraph-agent-bin.s3.amazonaws.com/v0.0.30/costgraph-agent_v0.0.30_linux_arm64.tar.gz"
      sha256 "b6b0df30f41ecf0dc30dd10e4df3911f2afe62554da3089bcc62143e80b9876c"
      def install
        bin.install "costgraph-agent"
        if OS.mac?
          if Hardware::CPU.arm?
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_arm64.dylib" => "libdarwin_exporter.dylib"
          else
            lib.install "internal/collectors/darwinexporter/libdarwin_exporter_amd64.dylib" => "libdarwin_exporter.dylib"
          end
        end
      end
    end
  end

  def post_install
    (etc/"costgraph_agent").mkpath
    conf = etc/"costgraph_agent/config.yaml"

    unless conf.exist?
      conf.write <<~EOS
        # Costgraph Agent configuration
        api_key: ""
      EOS
    end
  end

  def caveats
    <<~EOS
      This formula requires additional configuration post-installation.

      Update the configuration file at #{etc}/costgraph_agent/config.yaml. It requires an API key which you can obtain from the Costgraph UI.

      To start the service, run `sudo brew services start #{name}`
    EOS
  end

  service do
    run ["#{opt_bin}/costgraph-agent", "--config", "#{etc}/costgraph_agent/config.yaml"]
    keep_alive true
    log_path "#{var}/log/costgraph_agent.log"
    error_log_path "#{var}/log/costgraph_agent.error.log"
    require_root true
  end

  test do
    assert_predicate("#{opt_bin}/costgraph-agent", :exist?)
  end
end
